var dChr,game,__currentPlayer;function endConversation(){__currentNPCConversing=""}function setNPCstate(e,t){game.characters[e].currentState=t}function getNPCstate(e,t){return game.characters[e].currentState}function showTopic(e,t,n){t?game.characters[e].states[t].__hidden[n]=!1:game.characters[e].topics.__hidden[n]=!1}function hideTopic(e,t,n){t?game.characters[e].states[t].__hidden[n]=!0:game.characters[e].topics.__hidden[n]=!0}function hideCurrentTopic(){hideTopic(__currentNPCConversing,__currentConversingState,__currentConversingTopic)}function deleteTopic(e,t,n){t?delete game.characters[e].states[t][n]:delete game.characters[e].topics[n]}function deleteCurrentTopic(){deleteTopic(__currentNPCConversing,__currentConversingState,__currentConversingTopic)}function deleteCharacter(e){const t=getRoomOfCharacter(e);if(game.rooms[t].characters){const n=game.rooms[t].characters.indexOf(e);game.rooms[t].characters.splice(n,1)}}function putCharacterInRoom(e,t){game.rooms[t]&&(game.rooms[t].characters||(game.rooms[t].characters=[]),game.rooms[t].characters.push(e))}function silentMoveCharacterToRoom(e,t){deleteCharacter(e),putCharacterInRoom(e,t)}function moveCharacterToRoom(e,t){const n=game.characters[e];n.moveMessage&&n.moveMessage(t),silentMoveCharacterToRoom(e,t)}function getRoomOfCharacter(e){const t=game.rooms;for(const[n,r]of Object.entries(t))if(r.characters&&r.characters.indexOf(e)>-1)return n;return""}var dObj,__displayObjects=[],__currentNPCConversing="",__currentConversingState="",__currentConversingTopic="";function lookForBreaks(e){var t="",n=!1;for(var r=(e=e+" ").length,o=0;o<r;)"<"===e[o]&&(n=!0),">"===e[o]&&(n=!1),"~"===e[o]&&"~"===e[o+1]&&!1===n?(t+="<br>&nbsp;<br>",o++):"-"===e[o]&&"-"===e[o+1]&&!1===n?(t+="&mdash;",o++):t+=e[o],o++;return t}function fixQuotes(e){for(var t=!1,n="",r=lookForBreaks(e),o=r.length,c=0;c<o;c++){if("<"===r[c]&&(t=!0),">"===r[c]&&(t=!1),'"'===r[c]&&!1===t)(s=r[c+1])&&(!0===checkValidCharacter(s)?n+="&ldquo;":n+="&rdquo;");else if("'"===r[c]&&!1===t){var s;!0===checkValidCharacter(s=r[c-1])?n+="&rsquo;":n+="&lsquo;"}else n+=r[c]}return n}function checkIfDigit(e){var t=Number(e);return NaN!=t&&Boolean([!0,!0,!0,!0,!0,!0,!0,!0,!0,!0][t])}function checkIfLetter(e){return e.toUpperCase()!=e.toLowerCase()}function checkValidCharacter(e){return">"!==e&&""!==e.trim()}function parseTextToDisplayObject(e){switch(typeof e){case"function":return e();case"object":return Array.isArray(e)?e.join(""):"";default:return e}}function msg(e){const t=parseTextToDisplayObject(e);__displayObjects.push(t)}function checkIfLetter(e){return e.toUpperCase()!=e.toLowerCase()}function checkForParagraphIndents(e){return e=e.replace(/ __/g,"<p>")}function refresh(){var e="";const t=getRoomOfCharacter(__currentPlayer),n=game.rooms[t];if(hideNextButton(),hideActions(),0===__displayObjects.length)msg(n.desc),getSpecialDescriptions(t);else if(""===__currentNPCConversing)showNextButton();else{const e=getConversationTopics();if(e){document.getElementById("Actions").innerHTML=fixQuotes(buildTopicsHTML(e,__currentNPCConversing))}}const r=document.getElementById("Readout");if(r){for(const t of __displayObjects)e+=t;e=fixQuotes(e=handleStringCaps(e=addHyperLinks(t,e=checkForParagraphIndents(e)))),r.innerHTML=e}__displayObjects=[]}function showNextButton(){document.getElementById("Next-Button").innerHTML='<p><button type="submit" id="Next-Button" onclick="refresh();">âžž</button></p>'}function hideNextButton(){document.getElementById("Next-Button").innerHTML=""}function hideActions(){document.getElementById("Actions").innerHTML=""}function handleStringCaps(e){for(var t="",n=(e=e+" ").length,r=0,o=!1,c=!0;r<n;){if("<"===e[r]&&(o=!0),">"===e[r]&&(o=!1),!1===o){var s=e[r];"."===s||"!"===s||"?"===s?('"'!==e[r+1]&&(c=!0),t+=s):!0===c&&checkIfLetter(s)?(t+=s.toUpperCase(),c=!1):t+=s}else t+=e[r];r++}return t}function getSpecialDescriptions(e){const t=["things","characters","scenery"];for(const n of t)if(game.rooms[e][n])for(const t of game.rooms[e][n])if(game[n][t].desc){msg(`<p>${parseTextToDisplayObject(game[n][t].desc)}</p>`)}}function getConversationTopics(){if(game.characters[__currentNPCConversing]){if((dChr=game.characters[__currentNPCConversing]).states&&dChr.currentState){const e=dChr.currentState;if(dChr.states[e])return dChr.states[e]}if(dChr.topics)return dChr.topics}return null}function buildTopicsHTML(e,t){var n="<ul>";const r=e.__hidden;(e=Object.keys(e)).length;for(const o of e)r[o]||0==o.indexOf("__")||(n+=`<a href="javascript:void(0);" onclick="handleTopic('${t}', '${o}');"><li>${o}</li></a>`);return`${n}</ul>`}function getNoun(e,t){var n=t;if(game[e][t]){var r=game[e][t];r&&(r.properNoun?n="function"==typeof r.properNoun?r.properNoun():r.properNoun:r.noun&&(n="function"==typeof r.noun?r.noun():r.noun))}return n}function addHyperLinks(e,t){const n='<a href="javascript:void(0);" onclick="handle',r=["things","characters","scenery"];for(const o of r)if(game.rooms[e][o])for(const r of game.rooms[e][o])for(;t.indexOf(`$${r}`)>-1;){const c=r.length,s=t.indexOf(`$${r}`),a=s+c+1,i=getNoun(o,r);t=__currentNPCConversing!==r?`${t.slice(0,s)}${n}Click('${o}','${e}','${r}');">${i}</a>${t.slice(a,t.length)}`:`${t.slice(0,s)}${i}${t.slice(s+c+1,t.length)}`}if(game.rooms[e].decorations)for(const r of Object.keys(game.rooms[e].decorations))for(;t.indexOf(`$${r}`)>-1;){const o=t.indexOf(`$${r}`),c=r.length;t=`${t.slice(0,o)}${n}Decorator('${r}', '${e}');">${r}</a>${t.slice(o+c+1,t.length)}`}if(game.rooms[e].exits)for(const r of Object.keys(game.rooms[e].exits))for(;t.indexOf(`$${r}`)>-1;){const o=t.indexOf(`$${r}`),c=r.length;t=`${t.slice(0,o)}${n}Exit('${r}', '${e}');">${r}</a>${t.slice(o+c+1,t.length)}`}return t}function handleDecorator(e,t){msg(game.rooms[t].decorations[e]()),refresh()}function handleExit(e,t){const n=game.rooms[t].exits[e];n&&(n.room&&moveCharacterToRoom(__currentPlayer,n.room),n.desc&&msg(n.desc)),refresh()}function handleTopic(e,t){var n,r=game.characters[e];if(r){r.states&&r.currentState?(n=r.states[r.currentState],__currentConversingState=r.currentState):n=r.topics,__currentConversingTopic=t;const e=n[t]();e&&(msg(e),refresh())}}function handleAction(e,t,n){var r=game[e][t];if(r){const e=r.actions[n]();e&&(msg(e),refresh())}}function handleClick(e,t,n){var r=game[e][n];if(r){dObj=r;var o={catagory:e,container:t,name:n,it:r};if("characters"===e&&r.hello){const e=r.hello(o);if(e)return __currentNPCConversing=n,msg(e),void refresh()}if(r.click){const t=r.click(o);if(t&&(msg(t),refresh()),r.actions){const t=buildActionsHTML(e,r.actions,n);document.getElementById("Actions").innerHTML=handleStringCaps(t)}}}}function checkGame(){const e=["things","characters"];for(const n of e){var t={};for(const e of Object.keys(Game.rooms))if(Game.rooms[e][n])for(const r of Game.rooms[e][n]){if(t[r]){const o=`Duplication of name: catagory ${n} ${r} in rooms: ${t[r]} and ${e}`;throw alert(o),o}t[r]=e}}}function buildConversationSchema(){for(const e of Object.keys(game.characters))if(game.characters[e].topics&&(game.characters[e].topics.__hidden||(game.characters[e].topics.__hidden={})),game.characters[e].states)for(const t of Object.keys(game.characters[e].states))game.characters[e].states[t].__hidden||(game.characters[e].states[t].__hidden={})}function startGame(){window.addEventListener("orientationchange",function(){}),checkGame(),restartGame(),refresh()}function deleteThing(e){const t=getRoomOfThing(e);if(game.rooms[t].things){const n=game.rooms[t].things.indexOf(e);game.rooms[t].things.splice(n,1)}}function putThingInRoom(e,t){game.rooms[t]&&(game.rooms[t].things||(game.rooms[t].things=[]),game.rooms[t].things.push(e))}function silentMoveThingToRoom(e,t){deleteThing(e),putThingInRoom(e,t)}function moveThingToRoom(e,t){const n=game.things[e];n.moveMessage&&n.moveMessage(t),silentMoveThingToRoom(e,t)}function getRoomOfThing(e){const t=game.rooms;for(const[n,r]of Object.entries(t))if(r.thing&&r.thing.indexOf(e)>-1)return n;return""}function restartGame(){const e=Object.create(metaInfo);document.title=e.title,__currentPlayer=e.startingPlayer,__currentNPCConversing="",__displayObjects=[],dObj=null,(game=Object.create(Game)).title=e.title,buildConversationSchema()}