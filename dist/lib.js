var dChr,dTop,game,__currentPlayer;function endConversation(){setNPCConversation("")}function beginConversation(e){const t=game.characters[e];if(t){const n={name:e,it:t};if(t.hello){(dChr=t).__catagory="characters",dChr.__name=e;const o=parseTextToDisplayObject(dChr.hello(n));o&&(setNPCConversation(e),msg(`<p>${o}`))}}}function setNPCstate(e,t){game.characters[e].currentState=t}function setState(e){dChr.currentState=e}function getNPCstate(e,t){return game.characters[e].currentState}function deleteTopic(e,t,n){t?delete game.characters[e].states[t][n]:delete game.characters[e].topics[n]}function deleteCurrentTopic(){deleteTopic(__currentNPCConversing,__currentConversingState,__currentConversingTopic)}function silentMoveCharacterToRoom(e,t){game.rooms[t]&&(game.characters[e].in=t)}function moveCharacterToRoom(e,t){const n=game.characters[e];n.moveMessage&&n.moveMessage(t),silentMoveCharacterToRoom(e,t)}function getRoomOfCharacter(e){return game.characters[e].in}var dObj,__displayObjects=[],__toBeDisplayed=[],__currentNPCConversing="",__currentConversingState="",__currentConversingTopic="",__transitionText="";function clickNextButton(){dObj=null,dChr=null,refresh()}function lookForBreaks(e){var t="",n=!1;for(var o=(e=e+" ").length,r=0;r<o;)"<"===e[r]&&(n=!0),">"===e[r]&&(n=!1),"~"===e[r]&&"~"===e[r+1]&&!1===n?(t+="<br>&nbsp;<br>",r++):"-"===e[r]&&"-"===e[r+1]&&!1===n?(t+="&mdash;",r++):t+=e[r],r++;return t}function fixQuotes(e){for(var t=!1,n="",o=lookForBreaks(e),r=o.length,s=0;s<r;s++){if("<"===o[s]&&(t=!0),">"===o[s]&&(t=!1),'"'===o[s]&&!1===t)(c=o[s+1])&&(!0===checkValidCharacter(c)?n+="&ldquo;":n+="&rdquo;");else if("'"===o[s]&&!1===t){var c;!0===checkValidCharacter(c=o[s-1])?n+="&rsquo;":n+="&lsquo;"}else n+=o[s]}return n}function handleHeadingTags(e){for(let t=6;t>0;t--){const n="#".repeat(t),o=new RegExp(n+" .*","g"),r=e.match(o);if(r)for(const n of r){const o=n.replace(/#/g,"");e=e.replace(n,`<h${t}>${o}</h${t}>`)}}return e}function handleItalicsTags(e){const t=[[/_.+_/,"_"],[/\*.+\*/,"\\*"]];for(pattern of t){const[t,n]=pattern,o=e.match(t);if(o)for(const t of o)if("___"!==t){const o=new RegExp(n,"g"),r=t.replace(o,"");e=e.replace(t,`<i>${r}</i>`)}}return e}function handleBoldTags(e){const t=e.match(/\*\*.*\*\*/g);if(t)for(const n of t){const t=n.replace(/\*\*/g,"");e=e.replace(n,`<b>${t}</b>`)}return e}function handleRuleTags(e){const t=[/\n\s*___/g,/\n\s*\*\*\*/g,/\n\s*\_\_\_/g];for(pattern of t){const t=e.match(pattern);if(t)for(const n of t)e=e.replace(n,"<hr />")}return e}function handleLongDashTags(e){const t=e.match(/--/g);if(t)for(const n of t)e=e.replace(n,"&mdash;");return e}function handleBlockQuotes(e){e=e.split(/\n/);let t="",n=!1;for(line of e)"> "===line.trim().slice(0,2)?(!1===n&&(t+="<blockquote>"),n=!0,t+=line.trim().slice(2,line.length)+"<br />"):(!0===n&&(t+="</blockquote>",n=!1),t+=line+"\n");return t}function addParagraphs(e){return e.replace(/\n\s*\n/g," <p>")}function checkIfDigit(e){var t=Number(e);return NaN!=t&&Boolean([!0,!0,!0,!0,!0,!0,!0,!0,!0,!0][t])}function setNPCConversation(e){__currentNPCConversing=e}function setRoomTransition(e){__transitionText=parseTextToDisplayObject(e)}function checkIfLetter(e){return e.toUpperCase()!=e.toLowerCase()}function checkValidCharacter(e){return">"!==e&&""!==e.trim()}function parseTextToDisplayObject(e){switch(typeof e){case"function":return e();case"object":return Array.isArray(e)?e.join(""):"";default:return e}}function msg(e){const t=parseTextToDisplayObject(e);__displayObjects.push(t)}function checkIfLetter(e){return e.toUpperCase()!=e.toLowerCase()}function processText(e,t){return t=fixQuotes(t=handleLongDashTags(t=addHyperLinks(e,t=addParagraphs(t=handleStringCaps(t=handleBlockQuotes(t=handleRuleTags(t=handleItalicsTags(t=handleBoldTags(t=handleHeadingTags(t))))))))))}function handleNormalMode(e){const t=game.rooms[e];if(0===__displayObjects.length&&t){__transitionText&&(msg(`<p>${__transitionText}</p>`),__transitionText="");const n=parseTextToDisplayObject(t.text);n&&msg(`<p>${n}</p>`),getSpecialDescriptions(e)}else showNextButton()}function handleConversationMode(){const e=getConversationTopics();return e?buildTopicsHTML(e,__currentNPCConversing):""}function getDisplayContainer(){return game.characters[__currentPlayer].in}function refresh(){let e="";const t=getDisplayContainer();hideNextButton(),""===__currentNPCConversing?(handleNormalMode(t),dObj&&dObj.actions&&(e=buildActionsHTML(dObj.__catagory,dObj.actions,dObj.__name))):e=handleConversationMode();const n=document.getElementById("Display");n&&(n.innerHTML=processText(t,__displayObjects.join(" "))+e),__displayObjects=[]}function showNextButton(){document.getElementById("Next-Button").innerHTML='<p><button type="submit" id="Next-Button" onclick="clickNextButton();">âžž</button></p>'}function hideNextButton(){document.getElementById("Next-Button").innerHTML=""}function hideActions(){document.getElementById("Actions").innerHTML=""}function handleStringCaps(e){for(var t="",n=(e=e+" ").length,o=0,r=!1,s=!0,c=!1;o<n;){if("&"===e[o]&&(c=!0),";"===e[o]&&(c=!1),"<"===e[o]&&(r=!0),">"===e[o]&&(r=!1),!1===r&&!1===c){var a=e[o];"."===a||"!"===a||"?"===a?('"'!==e[o+1]&&(s=!0),t+=a):!0===s&&checkIfLetter(a)?(t+=a.toUpperCase(),s=!1):t+=a}else t+=e[o];o++}return t}function getSpecialDescriptions(e){const t=["things","characters","scenery"];for(const n of t)if(game[n])for(const t of Object.keys(game[n]))if(game[n][t].in===e&&game[n][t].text){msg(`<p>${parseTextToDisplayObject(game[n][t].text)}</p>`)}}function getConversationTopics(){if(game.characters[__currentNPCConversing]){if((dChr=game.characters[__currentNPCConversing]).states&&dChr.currentState){const e=dChr.currentState;if(dChr.states[e])return dChr.states[e]}if(dChr.topics)return dChr.topics}return null}function determineTopicShow(e){if("function"==typeof e)return!0;if("string"==typeof e)return!0;if("object"==typeof e){if("function"!=typeof e.shown)return!0===e.shown||!1!==e.shown;if(e.shown())return!0}}function buildTopicsHTML(e,t){var n="<ul>";for(const[o,r]of Object.entries(e))determineTopicShow(r)&&(n+=`<a href="javascript:void(0);" onclick="handleTopic(\`${t}\`, \`${o}\`);"><li>${o}</li></a>`);return`${n}</ul>`}function getNoun(e,t){var n=t;if(game[e][t]){var o=game[e][t];o&&(o.properNoun?n="function"==typeof o.properNoun?o.properNoun():o.properNoun:o.noun&&(n="function"==typeof o.noun?o.noun():o.noun))}return n}function addHyperLinks(e,t){const n='<a href="javascript:void(0);" onclick="handle',o=["things","characters"];for(const r of o)if(game[r])for(const o of Object.keys(game[r]))if(game[r][o].in===e){const e=t.indexOf(`$${o}`);if(e>-1){const s=o.length,c=e+s+1,a=getNoun(r,o);t=__currentNPCConversing!==o?`${t.slice(0,e)}${n}Click('${r}','${o}');">${a}</a>${t.slice(c,t.length)}`:`${t.slice(0,e)}${a}${t.slice(e+s+1,t.length)}`}}if(game.rooms[e].decorations)for(const o of Object.keys(game.rooms[e].decorations))for(;t.indexOf(`$${o}`)>-1;){const r=t.indexOf(`$${o}`),s=o.length;t=`${t.slice(0,r)}${n}Decorator('${o}', '${e}');">${o}</a>${t.slice(r+s+1,t.length)}`}if(game.scenery)for(const e of Object.keys(game.scenery))for(;t.indexOf(`$${e}`)>-1;){const o=t.indexOf(`$${e}`),r=e.length,s=getNoun("scenery",e);t=`${t.slice(0,o)}${n}Click('scenery','${e}');">${s}</a>${t.slice(o+r+1,t.length)}`}if(game.rooms[e].links)for(const o of Object.keys(game.rooms[e].links))for(;t.indexOf(`$${o}`)>-1;){const r=t.indexOf(`$${o}`),s=o.length;t=`${t.slice(0,r)}${n}Link('${o}', '${e}');">${o}</a>${t.slice(r+s+1,t.length)}`}return t}function handleDecorator(e,t){msg("<p>"+game.rooms[t].decorations[e]()),refresh()}function handleLink(e,t){const n=game.rooms[t].links[e];n&&(n.room&&(n.preMove&&msg(n.preMove),n.postMove&&setRoomTransition(n.postMove),moveCharacterToRoom(__currentPlayer,n.room)),n.preventMove&&msg(n.preventMove)),refresh()}function handleTopic(e,t){const n=game.characters[e];var o;if(n){n.states&&n.currentState?(o=n.states[n.currentState],__currentConversingState=n.currentState):o=n.topics,__currentConversingTopic=t;const e=o[t];if("object"==typeof e){let t="";(t="function"==typeof(dTop=e).text?dTop.text():dTop.text)&&msg("<p>"+t),e.nextState?setState(e.nextState):""===e.nextState&&endConversation()}else if("function"==typeof e){const t=e();t&&msg("<p>"+t)}else e&&msg("<p>"+e);refresh()}}function handleAction(e,t,n){var o=game[e][t];if(o){const e=o.actions[n]();e&&(msg(e),refresh())}}function handleClick(e,t){var n=game[e][t];if(n){(dObj=n).__catagory=e,dObj.__name=t;var o={catagory:e,name:t,it:n};if("characters"===e&&n.hello)beginConversation(t);else if(n.click){const e=n.click(o);e&&msg("<p>"+e)}refresh()}}function checkNameDuplication(){const e=["things","characters"];for(const n of e){var t={};for(const e of Object.keys(Game.rooms))if(Game.rooms[e][n])for(const o of Game.rooms[e][n]){if(t[o]){const r=`Duplication of name: catagory ${n} ${o} in rooms: ${t[o]} and ${e}`;throw alert(r),r}t[o]=e}}}function startGame(){window.addEventListener("orientationchange",function(){refresh()}),restartGame(),refresh()}function deleteThing(e){const t=getRoomOfThing(e);if(game.rooms[t].things){const n=game.rooms[t].things.indexOf(e);game.rooms[t].things.splice(n,1)}}function putThingInRoom(e,t){game.rooms[t]&&(game.rooms[t].things||(game.rooms[t].things=[]),game.rooms[t].things.push(e))}function silentMoveThingToRoom(e,t){deleteThing(e),putThingInRoom(e,t)}function moveThingToRoom(e,t){const n=game.things[e];n.moveMessage&&n.moveMessage(t),silentMoveThingToRoom(e,t)}function getRoomOfThing(e){const t=game.rooms;for(const[n,o]of Object.entries(t))if(o.thing&&o.thing.indexOf(e)>-1)return n;return""}function restartGame(){const e=Object.create(metaInfo);document.title=e.title,__currentPlayer=e.startingPlayer,__currentNPCConversing="",__displayObjects=[],dObj=null,dChr=null,(game=Object.create(Game)).title=e.title}